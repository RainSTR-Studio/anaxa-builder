use crate::schema::{ConfigItem, ConfigType};
use anyhow::Result;
use std::collections::HashMap;
use std::fmt::Write;

pub fn generate_consts(
    items: &[ConfigItem],
    values: &HashMap<String, toml::Value>,
) -> Result<String> {
    let mut buffer = String::new();

    writeln!(buffer, "// Generated by anaxa-config")?;
    writeln!(buffer, "#![allow(dead_code)]")?;
    writeln!(buffer)?;

    for item in items {
        if let Some(val) = values.get(&item.name) {
            match item.config_type {
                ConfigType::Bool => {
                    if let Some(b) = val.as_bool() {
                        writeln!(buffer, "pub const {}: bool = {};", item.name, b)?;
                    }
                }
                ConfigType::Int => {
                    if let Some(i) = val.as_integer() {
                        writeln!(buffer, "pub const {}: i64 = {};", item.name, i)?;
                    }
                }
                ConfigType::Hex => {
                    if let Some(i) = val.as_integer() {
                        writeln!(buffer, "pub const {}: u64 = 0x{:x};", item.name, i)?;
                    }
                }
                ConfigType::String | ConfigType::Choice => {
                    if let Some(s) = val.as_str() {
                        writeln!(buffer, "pub const {}: &str = \"{}\";", item.name, s)?;
                    }
                }
            }
        }
    }

    Ok(buffer)
}

pub fn generate_cargo_keys(
    items: &[ConfigItem],
    values: &HashMap<String, toml::Value>,
) -> Result<String> {
    let mut buffer = String::new();

    for item in items {
        if let Some(val) = values.get(&item.name) {
            if item.config_type == ConfigType::Bool && val.as_bool() == Some(true) {
                writeln!(buffer, "cargo:rustc-cfg={}", item.name)?;
            }
            match item.config_type {
                ConfigType::String | ConfigType::Choice => {
                    if let Some(s) = val.as_str() {
                        writeln!(buffer, "cargo:rustc-cfg={}=\"{}\"", item.name, s)?;
                    }
                }
                _ => {}
            }
        }
    }

    Ok(buffer)
}
